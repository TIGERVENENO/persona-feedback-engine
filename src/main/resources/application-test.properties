# ============================================================================
# Persona Feedback Engine - Test Configuration
# ============================================================================
# This profile is used when running unit and integration tests
# Uses H2 in-memory database for fast test execution
# ============================================================================

# ======== H2 Database Configuration (In-Memory) ========
spring.datasource.url=jdbc:h2:mem:testdb
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

# ======== H2 Console (for debugging, optional) ========
spring.h2.console.enabled=false

# ======== Hibernate/JPA Configuration ========
spring.jpa.database-platform=org.hibernate.dialect.H2Dialect
spring.jpa.hibernate.ddl-auto=create-drop
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.defer-datasource-initialization=true

# ======== Flyway Configuration ========
# Включаем Flyway для применения миграций в тестах
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true

# ======== SQL Script Initialization ========
# Отключаем встроенные скрипты инициализации
spring.sql.init.mode=never
spring.sql.init.data-locations=classpath:/nonexistent

# ======== RabbitMQ Configuration (use in-memory for tests) ========
spring.rabbitmq.host=localhost
spring.rabbitmq.port=5672
spring.rabbitmq.username=guest
spring.rabbitmq.password=guest

# ======== Disabled Auto-Configurations for Tests ========
# Disable all external dependencies and resilience4j to avoid bean creation issues
spring.autoconfigure.exclude=\
  org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration,\
  org.springframework.boot.autoconfigure.data.redis.RedisReactiveAutoConfiguration,\
  org.springframework.boot.autoconfigure.data.redis.RedisRepositoriesAutoConfiguration,\
  org.springframework.session.data.redis.config.annotation.web.http.RedisSessionConfiguration,\
  org.springframework.session.SessionAutoConfiguration,\
  org.redisson.spring.starter.RedissonAutoConfigurationV2,\
  org.redisson.spring.data.config.RedissonReactiveDataAutoConfiguration,\
  org.redisson.spring.data.config.RedissonReactiveRepositoriesAutoConfiguration,\
  io.github.resilience4j.springboot3.retry.autoconfigure.RetryAutoConfiguration,\
  io.github.resilience4j.springboot3.circuitbreaker.autoconfigure.CircuitBreakerAutoConfiguration,\
  io.github.resilience4j.springboot3.timelimiter.autoconfigure.TimeLimiterAutoConfiguration,\
  io.github.resilience4j.springboot3.bulkhead.autoconfigure.BulkheadAutoConfiguration,\
  io.github.resilience4j.springboot3.ratelimiter.autoconfigure.RateLimiterAutoConfiguration,\
  org.springframework.cloud.circuitbreaker.resilience4j.Resilience4jAutoConfiguration

# ======== Cache Configuration ========
spring.cache.type=none

# ======== Spring Framework Configuration ========
# Allow bean definition overrides for test mocks
spring.main.allow-bean-definition-overriding=true

# ======== AI Provider Configuration ========
app.ai.provider=openrouter

# ======== OpenRouter API Configuration ========
app.openrouter.api-key=test-api-key
app.openrouter.model=deepseek/deepseek-r1-0528:free
app.openrouter.timeout-seconds=30
app.openrouter.retry-delay-ms=1000

# ======== AgentRouter API Configuration ========
app.agentrouter.api-key=test-api-key
app.agentrouter.model=deepseek/deepseek-v3.1
app.agentrouter.timeout-seconds=30
app.agentrouter.retry-delay-ms=1000

# ======== Application-Specific Configuration ========
app.feedback.max-products-per-session=5
app.feedback.max-personas-per-session=5
app.feedback.max-prompt-length=2000

# ======== JWT Configuration ========
app.jwt.secret-key=test-jwt-secret-key-for-testing-only-not-production
app.jwt.expiration-hours=24

# ======== Logging Configuration (quiet for tests) ========
logging.level.root=WARN
logging.level.ru.tigran.personafeedbackengine=INFO
logging.level.org.springframework.web=WARN
logging.level.org.hibernate.SQL=WARN
logging.level.org.springframework.test=WARN
