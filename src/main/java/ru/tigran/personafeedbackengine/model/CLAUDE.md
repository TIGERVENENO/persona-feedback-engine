# model/

## Purpose
JPA entities and domain models for the persona feedback engine.

## Key Entities

### User
- Represents a platform user/marketer
- Root entity for data isolation via user_id in all queries
- Authentication: Email-based (no username field)
- Fields:
  - `id: Long` - Primary key
  - `email: String` - Unique user email (used for authentication instead of username)
  - `passwordHash: String` - BCrypt hashed password (60 chars, work factor 10)
  - `isActive: Boolean` - Account active status (default: true)
  - `deleted: Boolean` - Soft delete flag (default: false)
  - `createdAt: LocalDateTime` - Audit timestamp (auto)
  - `updatedAt: LocalDateTime` - Audit timestamp (auto)
- Cascades PERSIST and MERGE to owned Personas, Products, FeedbackSessions (NOT CASCADE on delete)

### Product
- A product/service to receive feedback on
- Owned by a User
- Referenced by FeedbackResults
- Fields:
  - `id: Long` - Primary key
  - `name: String` - Product name (required, 1-200 chars)
  - `description: String` - Product description (optional, max 5000 chars)
  - `price: BigDecimal` - Product price (optional)
  - `currency: String` - ISO 4217 currency code (optional, 3 chars: USD, RUB, EUR, etc.)
  - `category: String` - Product category (optional, max 100 chars)
  - `keyFeatures: List<String>` - Key product features stored as JSONB (optional)
  - `deleted: Boolean` - Soft delete flag (default: false)
  - `user: User` - Owner of the product (required)
- **JSONB Handling**: keyFeatures stored as JSONB in PostgreSQL
  - Uses @JdbcTypeCode(SqlTypes.JSON) annotation to explicitly declare JSON SQL type to Hibernate
  - Uses AttributeConverter (JsonbConverter) for List<String> ↔ JSON conversion
  - Converts List<String> to JSON string for database storage, and vice versa on retrieval

### Name
- **NEW**: Predefined names for persona generation, organized by country and gender
- Ensures culturally appropriate names match persona demographics
- Used by `PersonaService.selectRandomNames()` to pick names for batch persona generation
- Fields:
  - `id`: Primary key
  - `name`: The first name (no surname)
  - `gender`: "male" or "female"
  - `country`: ISO 3166-1 alpha-2 country code (RU, US, GB, DE, FR, etc.)
- Data:
  - 400 predefined names total
  - 10 male + 10 female names for each of 20 most popular countries
  - Countries: RU (Russia), US (USA), GB (UK), DE (Germany), FR (France), IT (Italy), ES (Spain), BR (Brazil), CN (China), IN (India), JP (Japan), KR (South Korea), MX (Mexico), CA (Canada), AU (Australia), NL (Netherlands), SE (Sweden), PL (Poland), TR (Turkey), NG (Nigeria)
- Unique constraint: (name, gender, country) - prevents duplicate entries
- Index: idx_names_country_gender - optimizes lookup by country and gender
- **Integration**: PersonaService uses NameRepository to fetch culturally appropriate names during batch persona generation

### Persona
- AI-generated character profiles for realistic feedback simulation
- Owned by a User
- States: GENERATING → ACTIVE or FAILED
- Caching key based on generation prompt (allows reusability across sessions)
- **Concurrency control** (CRITICAL-3 race condition fix):
  - `generationInProgress: Boolean` - Flag to prevent concurrent processing from multiple RabbitMQ consumer threads
  - Prevents `StaleObjectStateException` from optimistic locking when multiple threads update same entity
  - Set/cleared in separate transactions (REQUIRES_NEW propagation) to ensure atomicity
  - When flag is true, other consumer threads skip processing this persona
- **Demographic fields** (for indexing, searching, and persona reuse):
  - `demographicGender`: male|female|other (from request)
  - `age`: Exact age as Integer (from request)
  - `region`: moscow|spb|regions (from request location)
  - `incomeLevel`: low|medium|high (from request)
  - `country`: ISO 3166-1 alpha-2 country code (RU, US, GB, etc.)
  - `city`: City name (Moscow, New York, etc.)
  - `minAge`: Minimum age from request
  - `maxAge`: Maximum age from request
  - `activitySphere`: Activity sphere/industry (IT, FINANCE, HEALTHCARE, etc.)
  - `profession`: Specific profession/role (e.g., "Senior Software Engineer")
  - `income`: Income range/level (e.g., "$50k-$75k")
  - `interests`: JSON array of interests/hobbies
  - `additionalParams`: Additional custom parameters
  - `gender`: Generated by AI during persona generation
  - `ageGroup`: Generated by AI (18-24|25-34|35-44|45-54|55-64|65+)
  - `race`: Generated by AI (Asian|Caucasian|African|Hispanic|Middle Eastern|Indigenous|Mixed|Other)

### FeedbackSession
- Encapsulates a batch feedback generation request
- Owned by a User
- States: PENDING → IN_PROGRESS → COMPLETED or FAILED
- Contains multiple FeedbackResult entities
- Fields:
  - `id: Long` - Primary key
  - `status: FeedbackSessionStatus` - Current status (PENDING, IN_PROGRESS, COMPLETED, FAILED)
  - `language: String` - ISO 639-1 language code for feedback generation (EN, RU, FR, etc.)
  - `user: User` - Owner of the session
  - `feedbackResults: List<FeedbackResult>` - Collection of feedback results
  - `createdAt: LocalDateTime` - Audit timestamp (auto)
  - `updatedAt: LocalDateTime` - Audit timestamp (auto)

### FeedbackResult
- Individual feedback entry from one persona on one product
- References FeedbackSession, Persona, Product
- States: PENDING → IN_PROGRESS → COMPLETED or FAILED
- Stores generated feedback text

## Utility Classes

### JsonbConverter
- JPA AttributeConverter for List<String> ↔ JSON string conversion
- **Functionality**:
  - `convertToDatabaseColumn()`: List<String> → JSON string
  - `convertToEntityAttribute()`: JSON string → List<String>
  - Uses Jackson ObjectMapper for serialization
- Used by: Product.keyFeatures field for JSONB handling

## Relationships
- User 1:N Product
- User 1:N Persona
- User 1:N FeedbackSession
- FeedbackSession 1:N FeedbackResult
- Persona N:1 FeedbackResult
- Product N:1 FeedbackResult
